<!DOCTYPE html>
<html>

<head>
    <script>var SKALP_INITIAL_DATA = null;</script>
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <meta http-equiv="MSThemeCompatible" content="Yes" />
    <meta charset="utf-8" />

    <script src='js/jquery.js?v=20260101'> </script>
    <script src='js/skalp.js?v=20260102_fix'> </script>
    <link rel='stylesheet' href='css/hatch_dialog.css?v=20260101' />

    <link href="css/jquery-ui-1.10.4.custom.min.css?v=20260101" rel="stylesheet" />
    <script type="text/javascript" src="js/jquery-ui.min.js?v=20260101"></script>

    <link rel="stylesheet" type="text/css" href="css/jscslider.css?v=20260101">
    <script type="text/javascript" src="js/jscslider.js?v=20260101"></script>

    <!-- Spectrum Color Picker -->
    <link rel="stylesheet" type="text/css" href="css/spectrum.css?v=20260101">
    <script type="text/javascript" src="js/spectrum.js?v=20260101"></script>

    <title>Skalp Pattern Designer</title>

</head>
<script>
    function initializeFromData() {
        if (!window.SKALP_INITIAL_DATA) return;
        var data = SKALP_INITIAL_DATA;

        // Name
        if (data.hatch_name) $('#hatch_name').val(data.hatch_name);

        // Patterns List
        var $patList = $('#acad_pattern_list');
        if (data.pattern_list && $patList.length) {
            $patList.empty();
            data.pattern_list.forEach(function (pat) {
                $patList.append(new Option(pat, pat));
            });
        }

        // Settings
        if (data.settings) {
            var s = data.settings;

            // Pattern Type
            if (s.pattern_type) {
                $('#pattern_type').val(s.pattern_type);
                change_pattern_type(s.pattern_type, true);
            } else {
                // Determine pattern type from pattern name if not explicitly set
                if (data.pattern_name === "SOLID_COLOR, solid color without hatching") {
                    $('#pattern_type').val('solid');
                    change_pattern_type('solid', true);
                } else if (data.pattern_name === "CROSS_HATCH") {
                    $('#pattern_type').val('cross');
                    change_pattern_type('cross', true);
                } else if (data.pattern_name === "INSULATION") {
                    $('#pattern_type').val('insulation');
                    change_pattern_type('insulation', true);
                } else {
                    $('#pattern_type').val('hatch');
                    change_pattern_type('hatch', true);
                }
            }

            // Colors (update input value AND color block for initialization)
            if (s.line_color) {
                $('#line_color_input').val(s.line_color);
                $('#line_color_block').css('background-color', s.line_color);
            }
            if (s.fill_color) {
                $('#fill_color_input').val(s.fill_color);
                $('#fill_color_block').css('background-color', s.fill_color);
            }
            if (s.section_line_color) {
                var c = s.section_line_color || 'rgb(0,0,0)';
                $('#section_line_color_input').val(c);
                $('#section_line_color_block').css('background-color', c);
            }

            // Dropdowns & Inputs
            if (s.space) $('#units').val(s.space);

            // Tile sizes (Pre-formatted from Ruby)
            if (s.tile_x) $('#tile_x').val(s.tile_x);
            if (s.tile_y) $('#tile_y').val(s.tile_y);

            // Lineweights
            if (s.lineweight_model) $('#lineweight_model').val(s.lineweight_model);
            if (s.lineweight_paper) $('#lineweight_paper').val(s.lineweight_paper);

            // Section Cut Width
            if (s.sectioncut_linewidth) $('#sectioncut_linewidth').val(s.sectioncut_linewidth);

            // Align
            if (s.aligned) $("#align_pattern").prop('checked', s.aligned === 'true' || s.aligned === true);

            // Unify
            if (s.unify) $("#unify_material").prop('checked', s.unify === 'true' || s.unify === true);

            // Priority
            if (s.priority) $('#zindex').val(s.priority);

            // Selected Pattern
            if (data.pattern_name) {
                $patList.val(data.pattern_name);
            }
        }

        // Preview
        if (data.preview_base64) {
            var img = document.getElementById('hatch_preview');
            if (img) {
                img.src = "data:image/png;base64," + data.preview_base64;
                img.style.opacity = 1;
            }
        }
    }

    // Run as soon as DOM is ready, before other scripts ideally
    $(document).ready(function () {
        initializeFromData();
    });
</script>

<body onload="ready_hatch()" onfocus="onfocus_hatch()" scroll="no" style="OVERFLOW: hidden">

    <!-- Material Name -->
    <div id="material_name_div">
        <label for="hatch_name">Name:</label>
        <input type='text' title='Material name' id='hatch_name'>
    </div>

    <!-- Preview with inline zoom slider -->
    <div id="preview_container">
        <img class="preview" id="hatch_preview" src="icons/skalp_empty.png" style="opacity:0;"
            onload="this.style.opacity=1; is_busy=false;">
        <div id="preview_zoom_row">
            <h2 id="translate_03">Preview Zoom:</h2>
            <input type="range" min="5" max="100" value="60" class="slider" id="slider"
                style="position: relative; left: 93px;" oninput="debounced_create_preview(0)"
                onchange="debounced_create_preview(0)">
            <style>
                /* Adjusted slider position */
                .jscslider,
                #id_jscslider_0 {
                    left: 0px !important;
                    margin: 0 auto !important;
                    position: relative !important;
                    display: block !important;
                }
            </style>
        </div>
    </div>

    <div id="pattern_settings">

        <!-- Pattern definition Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('autocad_section')">
                <span class="toggle-icon">▼</span>
                <h3>Pattern definition</h3>
            </div>
            <div id="autocad_section" class="section-content">
                <!-- Pattern Type -->
                <div class="field-row">
                    <label for="pattern_type">Pattern Type:</label>
                    <select id="pattern_type" onchange="change_pattern_type(this.value)">
                        <option value="hatch">Standard Hatch</option>
                        <option value="solid">Solid Color</option>
                        <option value="cross">Cross Hatch</option>
                        <option value="insulation">Insulation</option>
                    </select>
                </div>

                <!-- Tile Size -->
                <div class="field-row">
                    <label>Tile Size:</label>
                    <div class="field-inputs">
                        <input type='text' class="drawing_scale tile-input" title='Define Pattern Height' id='tile_y'
                            style="color: #CC0000;">
                        <img src='icons/gauge.png' id="tile_operator">
                        <input type='text' class="drawing_scale tile-input" title='Define Pattern Width' id='tile_x'
                            style="color: #00AA00;">
                    </div>
                </div>

                <!--Pattern -->
                <div class="field-row">
                    <label for="acad_pattern_list">Pattern:</label>
                    <select id="acad_pattern_list" onchange="select_pattern(this.value)"></select>
                </div>

                <!-- Type -->
                <div class="field-row" id="units_row">
                    <label for="units">Type:</label>
                    <select id="units" onchange="units(this.value)">
                        <option value='paperspace'>Scale Dependent</option>
                        <option value='modelspace'>Absolute Size</option>
                    </select>
                </div>

                <!-- Insulation Style -->
                <div class="field-row" id="insulation_style_row" style="display:none;">
                    <label for="insulation_style">Insulation Style:</label>
                    <select id="insulation_style" onchange="create_preview(0)">
                        <option value="zigzag">ZigZag</option>
                        <option value="scurve">S-Curve</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Pattern styling Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('pattern_section')">
                <span class="toggle-icon">▼</span>
                <h3>Pattern styling</h3>
            </div>
            <div id="pattern_section" class="section-content">
                <!-- Pattern Fill Color -->
                <div class="field-row">
                    <label id="translate_06">Fill Color:</label>
                    <div id="fill_color_block" class="color-block" style="background-color: rgb(255, 255, 255);"></div>
                </div>

                <!-- Pattern Line Color -->
                <div class="field-row" id="pattern_line_color_row">
                    <label id="translate_17">Line Color:</label>
                    <div id="line_color_block" class="color-block" style="background-color: rgb(0, 0, 0);"></div>
                </div>

                <!-- Pattern Line Width Paper -->
                <div class="field-row" id="pattern_line_width_row">
                    <label id="translate_08">Line Width:</label>
                    <select id='lineweight_paper' onchange="$('#update_preview').show();create_preview(0);">
                        <option value='0.04 mm'>0.04 mm</option>
                        <option value='0.07 mm'>0.07 mm</option>
                        <option value='0.13 mm'>0.13 mm</option>
                        <option value='0.18 mm' selected>0.18 mm</option>
                        <option value='0.25 mm'>0.25 mm</option>
                        <option value='0.35 mm'>0.35 mm</option>
                        <option value='0.50 mm'>0.50 mm</option>
                        <option value='0.70 mm'>0.70 mm</option>
                        <option value='1.00 mm'>1.00 mm</option>
                        <option value='2.00 mm'>2.00 mm</option>
                        <option value='0.1 pt'>0.1 pt</option>
                        <option value='0.2 pt'>0.2 pt</option>
                        <option value='0.4 pt'>0.4 pt</option>
                        <option value='0.6 pt'>0.6 pt</option>
                        <option value='0.8 pt'>0.8 pt</option>
                        <option value='1.0 pt'>1.0 pt</option>
                        <option value='1.5 pt'>1.5 pt</option>
                        <option value='2.0 pt'>2.0 pt</option>
                        <option value='3.0 pt'>3.0 pt</option>
                        <option value='4.0 pt'>4.0 pt</option>
                        <option value='5.0 pt'>5.0 pt</option>
                    </select>
                    <!-- Hidden lineweight_model for skalp.js compatibility -->
                    <input type="hidden" id="lineweight_model" value="0.35 mm">
                </div>
            </div>
        </div>

        <!-- Section styling Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('section_section')">
                <span class="toggle-icon">▼</span>
                <h3>Section styling</h3>
            </div>
            <div id="section_section" class="section-content">
                <!-- Section Line Color -->
                <div class="field-row">
                    <label id="translate_section_line_color">Line Color:</label>
                    <div id="section_line_color_block" class="color-block" style="background-color: rgb(0, 0, 0);">
                    </div>
                </div>

                <!-- Section Line Width -->
                <div class="field-row">
                    <label id="translate_05">Line Width:</label>
                    <select id='sectioncut_linewidth' onchange="$('#update_preview').show();create_preview(0);">
                        <option value='0.00 mm'>none</option>
                        <option value='0.04 mm'>0.04 mm</option>
                        <option value='0.07 mm'>0.07 mm</option>
                        <option value='0.13 mm'>0.13 mm</option>
                        <option value='0.18 mm'>0.18 mm</option>
                        <option value='0.25 mm'>0.25 mm</option>
                        <option value='0.35 mm'>0.35 mm</option>
                        <option value='0.50 mm'>0.50 mm</option>
                        <option value='0.70 mm'>0.70 mm</option>
                        <option value='1.00 mm'>1.00 mm</option>
                        <option value='2.00 mm'>2.00 mm</option>
                        <option value='0.1 pt'>0.1 pt</option>
                        <option value='0.2 pt'>0.2 pt</option>
                        <option value='0.4 pt'>0.4 pt</option>
                        <option value='0.6 pt'>0.6 pt</option>
                        <option value='0.8 pt'>0.8 pt</option>
                        <option value='1.0 pt'>1.0 pt</option>
                        <option value='1.5 pt'>1.5 pt</option>
                        <option value='2.0 pt'>2.0 pt</option>
                        <option value='3.0 pt'>3.0 pt</option>
                        <option value='4.0 pt'>4.0 pt</option>
                        <option value='5.0 pt'>5.0 pt</option>
                    </select>
                </div>

                <!-- Unify Material -->
                <div class="field-row">
                    <label>Join Section Lines:</label>
                    <input type="checkbox" name="unify material" value="unify" id="unify_material"
                        onchange="$('#update_preview').show();create_preview(0);">
                </div>
            </div>
        </div>

        <!-- Options Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('options_section')">
                <span class="toggle-icon">▼</span>
                <h3>Options</h3>
            </div>
            <div id="options_section" class="section-content">
                <!-- Align with Objects -->
                <div class="field-row">
                    <label id='translate_18'
                        title="Align red X-axis with the longest Edge in an Objects section result">Align with
                        Objects:</label>
                    <input type="checkbox" name="align with object" value="align" id="align_pattern"
                        title="Align red X-axis with the longest Edge in an Objects section result"
                        onchange="$('#update_preview').show();">
                </div>

                <!-- Drawing Priority -->
                <div class="field-row">
                    <label>Drawing Priority:</label>
                    <select id="zindex" onchange="$('#update_preview').show();create_preview(0);">
                        <option value="-1">low</option>
                        <option value="0" selected>normal</option>
                        <option value="1">high</option>
                    </select>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer with CANCEL and SAVE buttons -->
    <div class="dialog-footer">
        <button class="btn-cancel" onclick="cancel_edit()">CANCEL</button>
        <button class="btn-save" onclick="save_material()">SAVE</button>
    </div>

    <!-- Hidden Input Container for Spectrum Pickers (Moved here to prevent UI artifacts in field-rows) -->
    <div style="display:none;">
        <input type="text" id="fill_color_input" class="spectrum-picker" value="rgb(255,255,255)">
        <input type="text" id="line_color_input" class="spectrum-picker" value="rgb(0,0,0)">
        <input type="text" id="section_line_color_input" class="spectrum-picker" value="rgb(0,0,0)">
    </div>

    <script>
        function change_pattern_type(type, no_preview) {
            // Hide/Show relevant sections
            if (type === 'solid') {
                $('#acad_pattern_list').parent().hide();
                $('#tile_y').parent().parent().hide();
                $('#units_row').hide();
                $('#pattern_line_color_row').hide();
                $('#pattern_line_width_row').hide();
                $('#insulation_style_row').hide();
                $('#align_pattern').parent().hide();
            } else if (type === 'cross') {
                $('#acad_pattern_list').parent().hide();
                $('#tile_y').parent().parent().hide();
                $('#units_row').hide();
                $('#pattern_line_color_row').show();
                $('#pattern_line_width_row').show();
                $('#insulation_style_row').hide();
                $('#align_pattern').parent().hide();
            } else if (type === 'insulation') {
                $('#acad_pattern_list').parent().hide();
                $('#tile_y').parent().parent().hide();
                $('#units_row').hide();
                $('#pattern_line_color_row').show();
                $('#pattern_line_width_row').show();
                $('#insulation_style_row').show();
                $('#align_pattern').parent().hide();
            } else { // hatch
                $('#acad_pattern_list').parent().show();
                $('#tile_y').parent().parent().show();
                $('#units_row').show();
                $('#pattern_line_color_row').show();
                $('#pattern_line_width_row').show();
                $('#insulation_style_row').hide();
                $('#align_pattern').parent().show();
            }

            if (!no_preview) create_preview(0);
            updateWindowHeight();
        }

        // Toggle section expand/collapse
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const header = section.previousElementSibling;
            const icon = header.querySelector('.toggle-icon');

            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                icon.textContent = '▼';
            } else {
                section.classList.add('collapsed');
                icon.textContent = '▶';
            }

            // Adjust window height after transition
            setTimeout(updateWindowHeight, 350);
        }

        function updateWindowHeight() {
            var body = document.body;
            var height = body.scrollHeight + 40; // larger buffer to ensure footer visibility
            var width = 235; // Target fixed width inclusive of 10px margins
            if (typeof sketchup !== 'undefined' && sketchup.resize_window) {
                sketchup.resize_window(width, height);
            }
        }

        // Initialize height on load
        window.onload = function () {
            ready_hatch();
            updateWindowHeight();
        };

        // Initialize Spectrum color pickers with alpha support
        $(function () {
            $(".spectrum-picker").spectrum({
                showAlpha: true,
                showPalette: false,
                showInput: false,
                showButtons: false,
                allowEmpty: false,
                preferredFormat: "rgb",
                clickoutFiresChange: true,
                replacerClassName: 'hidden-spectrum-replacer', // Hide default replacer via CSS
                move: function (color) {
                    var id = $(this).attr('id').replace('_input', '_block');
                    $('#' + id).css('background-color', color.toRgbString());
                },
                change: function (color) {
                    var id = $(this).attr('id').replace('_input', '_block');
                    $('#' + id).css('background-color', color.toRgbString());
                    create_preview(0);
                },
                hide: function (color) {
                    create_preview(0);
                }
            });

            // Link native blocks to spectrum (Event Delegation)
            $(document).on("click", ".color-block", function () {
                var inputId = $(this).attr('id').replace('_block', '_input');
                $("#" + inputId).spectrum("toggle");
            });

            // Force hide replacers to prevent artifacts
            $(".sp-replacer").hide();
        });

        // Convert hex color to rgb string for Ruby compatibility
        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if (result) {
                return 'rgb(' + parseInt(result[1], 16) + ', ' + parseInt(result[2], 16) + ', ' + parseInt(result[3], 16) + ')';
            }
            return hex;
        }

        // Convert rgb(r,g,b) string to hex
        function rgbToHex(rgb) {
            if (!rgb || rgb.indexOf('rgb') === -1) return rgb;
            var result = rgb.match(/\d+/g);
            if (result && result.length >= 3) {
                var r = parseInt(result[0]).toString(16).padStart(2, '0');
                var g = parseInt(result[1]).toString(16).padStart(2, '0');
                var b = parseInt(result[2]).toString(16).padStart(2, '0');
                return '#' + r + g + b;
            }
            return '#000000';
        }

        function colorToRgb(color) {
            return color.toRgbString();
        }

        // Helper to gather all params (Shared by create_preview and save_material)
        function get_current_params(force) {
            var pattern = document.getElementById('acad_pattern_list') ? document.getElementById('acad_pattern_list').value : '';
            var pattern_type = document.getElementById('pattern_type') ? document.getElementById('pattern_type').value : 'hatch';
            var insulation_style = document.getElementById('insulation_style') ? document.getElementById('insulation_style').value : 'zigzag';

            var tile_x = document.getElementById('tile_x') ? document.getElementById('tile_x').value : '';
            var tile_y = document.getElementById('tile_y') ? document.getElementById('tile_y').value : '';

            // Get colors from Spectrum pickers (with alpha support)
            // Use .try-catch based resilience or checks because Spectrum might not be fully init if accessed too early
            var lineColorObj = $("#line_color_input").spectrum("get");
            var fillColorObj = $("#fill_color_input").spectrum("get");
            var sectionLineColorObj = $("#section_line_color_input").spectrum("get");

            var lineColor = lineColorObj ? lineColorObj.toRgbString() : 'rgb(0, 0, 0)';
            var fillColor = fillColorObj ? fillColorObj.toRgbString() : 'rgb(255, 255, 255)';
            var sectionLineColor = sectionLineColorObj ? sectionLineColorObj.toRgbString() : 'rgb(0, 0, 0)';

            var units = document.getElementById('units') ? document.getElementById('units').value : '';
            var lineweight = document.getElementById('lineweight_paper') ? document.getElementById('lineweight_paper').value : '0.18 mm';
            var lineweight_model = document.getElementById('lineweight_model') ? document.getElementById('lineweight_model').value : '0.35 mm';
            var slider = document.getElementById('slider') ? document.getElementById('slider').value : '60';
            var isNew = force == 1 ? '1' : '0';
            var aligned = document.getElementById('align_pattern') && document.getElementById('align_pattern').checked ? 'true' : 'false';
            var sectionCutWidth = document.getElementById('sectioncut_linewidth') ? document.getElementById('sectioncut_linewidth').value : '0.35 mm';
            var materialName = document.getElementById('hatch_name') ? document.getElementById('hatch_name').value : '';

            var unify = document.getElementById('unify_material') && document.getElementById('unify_material').checked ? 'true' : 'false';
            var drawingPriority = document.getElementById('zindex') ? document.getElementById('zindex').value : '0';

            return [
                pattern,            // 0
                tile_x,             // 1
                units,              // 2
                lineweight,         // 3
                lineweight_model,   // 4
                lineColor,          // 5
                fillColor,          // 6
                slider,             // 7
                isNew,              // 8
                aligned,            // 9
                sectionCutWidth,    // 10
                materialName,       // 11
                sectionLineColor,   // 12
                unify,              // 13
                drawingPriority,    // 14
                pattern_type,       // 15
                insulation_style    // 16
            ].join(';');
        }

        // Color picker functions are now handled by Spectrum's change event
        function save_material() {
            var materialName = document.getElementById('hatch_name').value;
            if (!materialName || materialName.trim() === '') {
                alert('Please enter a material name');
                return;
            }

            // 1. Force a CREATE HATCH (with force=1 to be safe) to save the parameters to Ruby
            var params = get_current_params(1);
            sketchup.create_hatch(params);

            // 2. Then call save logic (which closes dialog)
            // Wait slightly to ensure order or assume sequential execution queue in SketchUp
            // We give it a tiny delay to allow Ruby to digest created_hatch
            setTimeout(function () {
                sketchup.save_material(materialName);
            }, 200);
        }

        function cancel_edit() {
            if (typeof sketchup !== 'undefined' && sketchup.cancel_edit) {
                sketchup.cancel_edit();
            } else {
                window.location = 'skp:cancel_edit@';
            }
        }

        // Instant CSS Zoom
        function preview_zoom(val) {
            // Map slider (10-200) to scale (0.5 - 2.0)
            // base is 60 -> 1.0
            var scale = val / 60.0;
            var img = document.getElementById('hatch_preview');
            // We scale the image via CSS transform for instant feedback
            img.style.transform = "scale(" + scale + ")";
        }

        // Debounce utility - only execute function after delay since last call
        var preview_timeout = null;
        function debounced_create_preview(force) {
            if (preview_timeout) {
                clearTimeout(preview_timeout);
            }
            preview_timeout = setTimeout(function () {
                create_preview(force);
            }, 100); // 100ms debounce
        }

        // Helper to update UI selection without triggering Ruby round-trip
        function select_material_ui_only(materialName) {
            if ($('#acad_pattern_list').length) {
                $('#acad_pattern_list').val(materialName);
            }
            if ($('#hatch_name').length) {
                $('#hatch_name').val(materialName);
            }
        }

        function create_preview(force) {
            var params = get_current_params(force);
            sketchup.create_preview(params);
        }
    </script>

    <!-- RUBY BRIDGE -->
    <input id="RUBY_BRIDGE" type="hidden">
    <input id="gauge_ratio" type="hidden">
    <input id="max_height" type="hidden" value=800>
    <input id="min_height" type="hidden" value=500>
    <input id="min_width" type="hidden" value=300>

</body>

</html>