<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <meta http-equiv="MSThemeCompatible" content="Yes" />
    <meta charset="utf-8" />

    <script src='js/jquery.js'> </script>
    <script src='js/skalp.js'> </script>
    <link rel='stylesheet' href='css/hatch_dialog.css' />

    <link href="css/jquery-ui-1.10.4.custom.min.css" rel="stylesheet" />
    <script type="text/javascript" src="js/jquery-ui.min.js"></script>

    <link rel="stylesheet" type="text/css" href="css/jscslider.css">
    <script type="text/javascript" src="js/jscslider.js"></script>

    <!-- Spectrum Color Picker -->
    <link rel="stylesheet" type="text/css" href="css/spectrum.css">
    <script type="text/javascript" src="js/spectrum.js"></script>

    <title>Skalp Pattern Designer</title>

</head>

<body onload="ready_hatch()" onfocus="onfocus_hatch()" scroll="no" style="OVERFLOW: hidden">

    <!-- Material Name -->
    <div id="material_name_div">
        <label for="hatch_name">Name:</label>
        <input type='text' title='Material name' id='hatch_name'>
    </div>

    <!-- Preview with inline zoom slider -->
    <div id="preview_container">
        <img class="preview" id="hatch_preview" src="icons/skalp_empty.png">
        <div id="preview_zoom_row">
            <h2 id="translate_03">Preview Zoom:</h2>
            <input type="range" min="5" max="100" value="60" class="slider" id="slider" onchange="create_preview(0)">
        </div>
    </div>

    <div id="pattern_settings">

        <!-- Pattern definition Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('autocad_section')">
                <span class="toggle-icon">▼</span>
                <h3>Pattern definition</h3>
            </div>
            <div id="autocad_section" class="section-content">
                <!-- Tile Size -->
                <div class="field-row">
                    <label>Tile Size:</label>
                    <div class="field-inputs">
                        <input type='text' class="drawing_scale tile-input" title='Define Pattern Height' id='tile_y'
                            style="color: #CC0000;">
                        <img src='icons/gauge.png' id="tile_operator">
                        <input type='text' class="drawing_scale tile-input" title='Define Pattern Width' id='tile_x'
                            style="color: #00AA00;">
                    </div>
                </div>

                <!--Pattern -->
                <div class="field-row">
                    <label for="acad_pattern_list">Pattern:</label>
                    <select id="acad_pattern_list" onchange="select_pattern(this.value)"></select>
                </div>

                <!-- Type -->
                <div class="field-row">
                    <label for="units">Type:</label>
                    <select id="units" onchange="units(this.value)">
                        <option value='paperspace'>Scale Dependent</option>
                        <option value='modelspace'>Absolute Size</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Pattern styling Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('pattern_section')">
                <span class="toggle-icon">▼</span>
                <h3>Pattern styling</h3>
            </div>
            <div id="pattern_section" class="section-content">
                <!-- Pattern Fill Color -->
                <div class="field-row">
                    <label id="translate_06">Fill Color:</label>
                    <div id="fill_color_block" class="color-block" style="background-color: rgb(255, 255, 255);"></div>
                    <input type="text" id="fill_color_input" class="spectrum-picker" value="rgb(255,255,255)"
                        style="display:none;">
                </div>

                <!-- Pattern Line Color -->
                <div class="field-row">
                    <label id="translate_17">Line Color:</label>
                    <div id="line_color_block" class="color-block" style="background-color: rgb(0, 0, 0);"></div>
                    <input type="text" id="line_color_input" class="spectrum-picker" value="rgb(0,0,0)"
                        style="display:none;">
                </div>

                <!-- Pattern Line Width Paper -->
                <div class="field-row">
                    <label id="translate_08">Line Width:</label>
                    <select id='lineweight_paper' onchange="$('#update_preview').show();create_preview(0);">
                        <option value='0.04 mm'>0.04 mm</option>
                        <option value='0.07 mm'>0.07 mm</option>
                        <option value='0.13 mm'>0.13 mm</option>
                        <option value='0.18 mm' selected>0.18 mm</option>
                        <option value='0.25 mm'>0.25 mm</option>
                        <option value='0.35 mm'>0.35 mm</option>
                        <option value='0.50 mm'>0.50 mm</option>
                        <option value='0.70 mm'>0.70 mm</option>
                        <option value='1.00 mm'>1.00 mm</option>
                        <option value='2.00 mm'>2.00 mm</option>
                        <option value='0.1 pt'>0.1 pt</option>
                        <option value='0.2 pt'>0.2 pt</option>
                        <option value='0.4 pt'>0.4 pt</option>
                        <option value='0.6 pt'>0.6 pt</option>
                        <option value='0.8 pt'>0.8 pt</option>
                        <option value='1.0 pt'>1.0 pt</option>
                        <option value='1.5 pt'>1.5 pt</option>
                        <option value='2.0 pt'>2.0 pt</option>
                        <option value='3.0 pt'>3.0 pt</option>
                        <option value='4.0 pt'>4.0 pt</option>
                        <option value='5.0 pt'>5.0 pt</option>
                    </select>
                    <!-- Hidden lineweight_model for skalp.js compatibility -->
                    <input type="hidden" id="lineweight_model" value="0.35 mm">
                </div>
            </div>
        </div>

        <!-- Section styling Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('section_section')">
                <span class="toggle-icon">▼</span>
                <h3>Section styling</h3>
            </div>
            <div id="section_section" class="section-content">
                <!-- Section Line Color -->
                <div class="field-row">
                    <label id="translate_section_line_color">Line Color:</label>
                    <div id="section_line_color_block" class="color-block" style="background-color: rgb(0, 0, 0);">
                    </div>
                    <input type="text" id="section_line_color_input" class="spectrum-picker" value="rgb(0,0,0)"
                        style="display:none;">
                </div>

                <!-- Section Line Width -->
                <div class="field-row">
                    <label id="translate_05">Line Width:</label>
                    <select id='sectioncut_linewidth' onchange="$('#update_preview').show();create_preview(0);">
                        <option value='0.00 mm'>none</option>
                        <option value='0.04 mm'>0.04 mm</option>
                        <option value='0.07 mm'>0.07 mm</option>
                        <option value='0.13 mm'>0.13 mm</option>
                        <option value='0.18 mm'>0.18 mm</option>
                        <option value='0.25 mm'>0.25 mm</option>
                        <option value='0.35 mm'>0.35 mm</option>
                        <option value='0.50 mm'>0.50 mm</option>
                        <option value='0.70 mm'>0.70 mm</option>
                        <option value='1.00 mm'>1.00 mm</option>
                        <option value='2.00 mm'>2.00 mm</option>
                        <option value='0.1 pt'>0.1 pt</option>
                        <option value='0.2 pt'>0.2 pt</option>
                        <option value='0.4 pt'>0.4 pt</option>
                        <option value='0.6 pt'>0.6 pt</option>
                        <option value='0.8 pt'>0.8 pt</option>
                        <option value='1.0 pt'>1.0 pt</option>
                        <option value='1.5 pt'>1.5 pt</option>
                        <option value='2.0 pt'>2.0 pt</option>
                        <option value='3.0 pt'>3.0 pt</option>
                        <option value='4.0 pt'>4.0 pt</option>
                        <option value='5.0 pt'>5.0 pt</option>
                    </select>
                </div>

                <!-- Unify Material -->
                <div class="field-row">
                    <label>Join Section Lines:</label>
                    <input type="checkbox" name="unify material" value="unify" id="unify_material"
                        onchange="$('#update_preview').show();create_preview(0);">
                </div>
            </div>
        </div>

        <!-- Options Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('options_section')">
                <span class="toggle-icon">▼</span>
                <h3>Options</h3>
            </div>
            <div id="options_section" class="section-content">
                <!-- Align with Objects -->
                <div class="field-row">
                    <label id='translate_18'
                        title="Align red X-axis with the longest Edge in an Objects section result">Align with
                        Objects:</label>
                    <input type="checkbox" name="align with object" value="align" id="align_pattern"
                        title="Align red X-axis with the longest Edge in an Objects section result"
                        onchange="$('#update_preview').show();">
                </div>

                <!-- Drawing Priority -->
                <div class="field-row">
                    <label>Drawing Priority:</label>
                    <select id="zindex" onchange="$('#update_preview').show();create_preview(0);">
                        <option value="-2">very low</option>
                        <option value="-1">low</option>
                        <option value="0" selected>neutral</option>
                        <option value="1">high</option>
                        <option value="2">very high</option>
                    </select>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer with CANCEL and SAVE buttons -->
    <div class="dialog-footer">
        <button class="btn-cancel" onclick="cancel_edit()">CANCEL</button>
        <button class="btn-save" onclick="save_material()">SAVE</button>
    </div>

    <script>
        // Toggle section expand/collapse
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const header = section.previousElementSibling;
            const icon = header.querySelector('.toggle-icon');

            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                icon.textContent = '▼';
            } else {
                section.classList.add('collapsed');
                icon.textContent = '▶';
            }

            // Adjust window height after transition
            setTimeout(updateWindowHeight, 350);
        }

        function updateWindowHeight() {
            var body = document.body;
            var height = body.scrollHeight + 5; // Use scrollHeight + small buffer
            var width = 235; // Target fixed width inclusive of 10px margins
            if (typeof sketchup !== 'undefined' && sketchup.resize_window) {
                sketchup.resize_window(width, height);
            }
        }

        // Initialize height on load
        window.onload = function () {
            ready_hatch();
            updateWindowHeight();
        };

        // Initialize Spectrum color pickers with alpha support
        $(function () {
            $(".spectrum-picker").spectrum({
                showAlpha: true,
                showPalette: false,
                showInput: false,
                showButtons: false,
                allowEmpty: false,
                preferredFormat: "rgb",
                clickoutFiresChange: true,
                replacerClassName: 'hidden-spectrum-replacer', // Hide default replacer via CSS
                move: function (color) {
                    var id = $(this).attr('id').replace('_input', '_block');
                    $('#' + id).css('background-color', color.toRgbString());
                },
                change: function (color) {
                    var id = $(this).attr('id').replace('_input', '_block');
                    $('#' + id).css('background-color', color.toRgbString());
                    create_preview(0);
                },
                hide: function (color) {
                    create_preview(0);
                }
            });

            // Link native blocks to spectrum
            $(".color-block").click(function () {
                var inputId = $(this).attr('id').replace('_block', '_input');
                $("#" + inputId).spectrum("toggle");
            });
        });

        // Convert hex color to rgb string for Ruby compatibility
        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if (result) {
                return 'rgb(' + parseInt(result[1], 16) + ', ' + parseInt(result[2], 16) + ', ' + parseInt(result[3], 16) + ')';
            }
            return hex;
        }

        // Convert rgb(r,g,b) string to hex
        function rgbToHex(rgb) {
            if (!rgb || rgb.indexOf('rgb') === -1) return rgb;
            var result = rgb.match(/\d+/g);
            if (result && result.length >= 3) {
                var r = parseInt(result[0]).toString(16).padStart(2, '0');
                var g = parseInt(result[1]).toString(16).padStart(2, '0');
                var b = parseInt(result[2]).toString(16).padStart(2, '0');
                return '#' + r + g + b;
            }
            return '#000000';
        }

        function colorToRgb(color) {
            return color.toRgbString();
        }

        // Color picker functions are now handled by Spectrum's change event
        function save_material() {
            var materialName = document.getElementById('hatch_name').value;
            if (!materialName || materialName.trim() === '') {
                alert('Please enter a material name');
                return;
            }
            sketchup.save_material(materialName);
        }

        function cancel_edit() {
            if (typeof sketchup !== 'undefined' && sketchup.cancel_edit) {
                sketchup.cancel_edit();
            } else {
                window.location = 'skp:cancel_edit@';
            }
        }

        function create_preview(force) {
            var pattern = document.getElementById('acad_pattern_list') ? document.getElementById('acad_pattern_list').value : '';
            var tile_x = document.getElementById('tile_x') ? document.getElementById('tile_x').value : '';
            var tile_y = document.getElementById('tile_y') ? document.getElementById('tile_y').value : '';

            // Get colors from Spectrum pickers (with alpha support)
            var lineColorObj = $("#line_color_input").spectrum("get");
            var fillColorObj = $("#fill_color_input").spectrum("get");
            var sectionLineColorObj = $("#section_line_color_input").spectrum("get");

            var lineColor = lineColorObj ? lineColorObj.toRgbString() : 'rgb(0, 0, 0)';
            var fillColor = fillColorObj ? fillColorObj.toRgbString() : 'rgb(255, 255, 255)';
            var sectionLineColor = sectionLineColorObj ? sectionLineColorObj.toRgbString() : 'rgb(0, 0, 0)';

            var units = document.getElementById('units') ? document.getElementById('units').value : '';
            var lineweight = document.getElementById('lineweight_paper') ? document.getElementById('lineweight_paper').value : '0.18 mm';
            var lineweight_model = document.getElementById('lineweight_model') ? document.getElementById('lineweight_model').value : '0.35 mm';
            var slider = document.getElementById('slider') ? document.getElementById('slider').value : '60';
            var isNew = force == 1 ? '1' : '0';
            var aligned = document.getElementById('align_pattern') && document.getElementById('align_pattern').checked ? 'true' : 'false';
            var sectionCutWidth = document.getElementById('sectioncut_linewidth') ? document.getElementById('sectioncut_linewidth').value : '0.35 mm';
            var materialName = document.getElementById('hatch_name') ? document.getElementById('hatch_name').value : '';

            var unify = document.getElementById('unify_material') && document.getElementById('unify_material').checked ? 'true' : 'false';
            var drawingPriority = document.getElementById('zindex') ? document.getElementById('zindex').value : '0';

            var params = [
                pattern,            // 0
                tile_x,             // 1
                units,              // 2
                lineweight,         // 3 - lineweight_paper
                lineweight_model,   // 4 - lineweight_model
                lineColor,          // 5
                fillColor,          // 6
                slider,             // 7
                isNew,              // 8
                aligned,            // 9
                sectionCutWidth,    // 10
                materialName,       // 11
                sectionLineColor,   // 12
                unify,              // 13
                drawingPriority     // 14
            ].join(';');

            sketchup.create_preview(params);
        }
    </script>

    <!-- RUBY BRIDGE -->
    <input id="RUBY_BRIDGE" type="hidden">
    <input id="gauge_ratio" type="hidden">
    <input id="max_height" type="hidden" value=800>
    <input id="min_height" type="hidden" value=500>
    <input id="min_width" type="hidden" value=300>

</body>

</html>