<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Drawing Scale Manager</title>
    <style>
        * {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            -webkit-focus-ring-color: rgba(0, 0, 0, 0) !important;
            outline: none !important;
        }

        :focus {
            outline: none !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 12px;
            margin: 0;
            padding: 0;
            background-color: #ebebeb;
            user-select: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .toolbar {
            display: flex;
            align-items: center;
            padding: 0 8px;
            background-color: #ebebeb;
            height: 38px;
            gap: 8px;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .tool-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-icon img {
            width: 28px;
            height: 28px;
        }

        .tool-icon:hover {
            opacity: 1;
        }

        .spacer {
            flex: 1;
        }

        #content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
            margin: 0 8px 4px 8px;
            border: 1px solid #b8b8b8;
            border-radius: 2px;
            overflow: hidden;
        }

        .list-container {
            flex-grow: 1;
            overflow-y: auto;
            background-color: white;
            background-image: repeating-linear-gradient(to bottom,
                    #ffffff 0px,
                    #ffffff 22px,
                    #f5f5f5 22px,
                    #f5f5f5 44px);
            background-attachment: local;
            outline: none;
        }

        .list-item {
            display: flex;
            align-items: center;
            height: 22px;
            cursor: default;
            padding: 0 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
        }

        .list-item:hover {
            background-color: rgba(56, 117, 215, 0.1) !important;
        }

        .list-item.selected {
            background-color: #3875d7 !important;
            color: #fff !important;
        }

        .status-bar {
            padding: 0 10px 4px 10px;
            background: #ebebeb;
            border: none;
            margin: 0 8px;
            color: #444;
            font-size: 11px;
            font-weight: normal;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            height: 20px;
            box-sizing: border-box;
        }

        .restore-btn {
            background: none;
            border: none;
            color: #0078d4;
            font-size: 11px;
            cursor: pointer;
            padding: 0;
            text-decoration: none;
        }

        .restore-btn:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="toolbar">
        <div class="tool-icon" id="add-scale" title="Add Custom Scale">
            <img src="../icons/box_section/dlg_add.svg">
        </div>
        <div class="tool-icon" id="remove-scale" title="Remove Selected Scale">
            <img src="../icons/box_section/dlg_delete.svg">
        </div>
    </div>

    <div id="content-area">
        <div class="list-container" id="scale-list">
            <!-- Items populated by JS -->
        </div>
    </div>

    <div class="status-bar">
        <div id="status-text">Ready</div>
        <button id="restore-defaults" class="restore-btn">Restore
            Defaults</button>
    </div>

    <!-- Custom Scale Overlay -->
    <div id="custom-scale-overlay"
        style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); z-index: 10; display: none; padding: 20px; align-items: center; justify-content: center;">
        <div
            style="background: white; border: 1px solid #ccc; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); padding: 15px; border-radius: 6px; width: 320px;">
            <h3 style="margin: 0 0 12px 0; border-bottom: 1px solid #eee; padding-bottom: 5px;">Add Custom Scale</h3>
            <div style="font-size: 11px; color: #666; margin-bottom: 8px;">Enter value with (optional) unit (e.g., 1,
                1cm, 1/8", 5')</div>
            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
                <input type="text" id="paper-input" placeholder="Paper (e.g. 1cm)"
                    style="flex: 1; padding: 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;">
                <span style="font-weight: bold; color: #666; padding: 0 5px;">=</span>
                <input type="text" id="model-input" placeholder="Model (e.g. 50m)"
                    style="flex: 1; padding: 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div id="parse-preview" style="font-size: 10px; color: #999; margin-top: 4px; text-align: right;"></div>
            <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 15px;">
                <button id="cancel-scale"
                    style="background: #f0f0f0; color: #333; border: 1px solid #ccc; padding: 5px 16px; border-radius: 4px; font-size: 12px; cursor: pointer;">Cancel</button>
                <button id="add-scale-btn"
                    style="background: #0078d4; color: white; padding: 5px 16px; border-radius: 4px; font-size: 12px; cursor: pointer; border: none;">Add
                    Scale</button>
            </div>
        </div>
    </div>

    <script src="../html/js/jquery.js"></script>
    <script>
        let availableScales = [];
        let selectedScale = null;

        function parseUnitValue(str) {
            if (!str) return null;
            str = str.trim().toLowerCase().replace(',', '.');

            // Handle fractions like 1/8
            let numeric = 0;
            const fractionMatch = str.match(/^(\d+)\/(\d+)/);
            if (fractionMatch) {
                numeric = parseFloat(fractionMatch[1]) / parseFloat(fractionMatch[2]);
                str = str.replace(fractionMatch[0], '').trim();
            } else {
                const numMatch = str.match(/^[\d\.]+/);
                if (!numMatch) return null;
                numeric = parseFloat(numMatch[0]);
                str = str.replace(numMatch[0], '').trim();
            }

            // Detect unit
            let multiplier = 1.0; // default mm
            if (str.includes('cm')) multiplier = 10.0;
            else if (str.includes('m')) multiplier = 1000.0;
            else if (str.includes('"') || str.includes('inch')) multiplier = 25.4;
            else if (str.includes("'") || str.includes('ft') || str.includes('foot')) multiplier = 304.8;

            return { value: numeric * multiplier, original: numeric, unit: str || 'mm' };
        }

        function parseScaleValue(scaleStr) {
            if (!scaleStr) return 50;
            const ratioMatch = scaleStr.match(/\(1:([\d\.]+)\)$/) || scaleStr.match(/^1:([\d\.]+)$/);
            if (ratioMatch) return parseFloat(ratioMatch[1]);
            if (scaleStr.includes(':')) {
                const parts = scaleStr.split(':');
                if (parts.length === 2 && parseFloat(parts[0]) !== 0) return parseFloat(parts[1]) / parseFloat(parts[0]);
            }
            return 50;
        }

        function renderList() {
            // Sort scales: Metric first, then Imperial. Both sorted from Large to Small (Ratio Ascending).
            const metric = [];
            const imperial = [];

            availableScales.forEach(s => {
                const isImperial = s.includes('"') || s.includes("'") || s.toLowerCase().includes('in') || s.toLowerCase().includes('ft');
                if (isImperial) imperial.push(s);
                else metric.push(s);
            });

            const sorter = (a, b) => parseScaleValue(a) - parseScaleValue(b);
            metric.sort(sorter);
            imperial.sort(sorter);

            availableScales = [...metric, ...imperial];

            const $list = $('#scale-list').empty();
            availableScales.forEach((s, i) => {
                const $item = $(`<div class="list-item">${s}</div>`);
                if (s === selectedScale) $item.addClass('selected');
                $item.on('click', () => {
                    $('.list-item').removeClass('selected');
                    $item.addClass('selected');
                    selectedScale = s;
                });
                $list.append($item);
            });

            updateStatus();
        }

        function updateStatus() {
            $('#status-text').text(`${availableScales.length} scale${availableScales.length !== 1 ? 's' : ''}`);
        }

        function safeCallback(action, data = "") {
            if (window.sketchup && window.sketchup[action]) window.sketchup[action](data);
            else window.location.href = `skp:${action}@${data}`;
        }

        $(document).ready(() => {
            safeCallback("ready");

            $('#add-scale').on('click', () => {
                $('#custom-scale-overlay').css('display', 'flex');
                $('#paper-input').val('').focus();
                $('#model-input').val('');
                $('#parse-preview').text('');
            });

            $('#remove-scale').on('click', () => {
                if (!selectedScale) return;
                const idx = availableScales.indexOf(selectedScale);
                if (idx > -1) {
                    availableScales.splice(idx, 1);
                    selectedScale = null;
                    renderList();
                    safeCallback("save_scales", JSON.stringify(availableScales));
                }
            });

            $('#restore-defaults').on('click', () => {
                if (confirm("Restore default scales? This will remove any custom scales you've added.")) {
                    safeCallback("restore_defaults");
                }
            });

            $('#paper-input, #model-input').on('input', function () {
                const p = parseUnitValue($('#paper-input').val());
                const m = parseUnitValue($('#model-input').val());
                if (p && m) {
                    const ratio = m.value / p.value;
                    const nice = Math.round(ratio * 100) / 100;
                    $('#parse-preview').text(`Detected Ratio: 1:${nice}`);
                } else {
                    $('#parse-preview').text('');
                }
            });

            $('#cancel-scale').on('click', () => {
                $('#custom-scale-overlay').hide();
            });

            $('#add-scale-btn').on('click', () => {
                const p = parseUnitValue($('#paper-input').val());
                const m = parseUnitValue($('#model-input').val());

                if (!p || !m) {
                    alert("Please enter valid sizes (e.g., 1cm, 50m)");
                    return;
                }

                const ratio = m.value / p.value;
                const niceRatio = Math.round(ratio * 100) / 100;

                const displayPaper = $('#paper-input').val().trim();
                const displayModel = $('#model-input').val().trim();
                const ratioStr = `1:${niceRatio}`;
                const primaryStr = `${displayPaper}:${displayModel}`;
                const newString = (primaryStr === ratioStr) ? primaryStr : `${primaryStr} (${ratioStr})`;

                // Check if scale already exists
                if (availableScales.includes(newString)) {
                    alert("This scale already exists in the list.");
                    return;
                }

                availableScales.push(newString);
                selectedScale = newString;
                renderList();
                $('#custom-scale-overlay').hide();
                safeCallback("save_scales", JSON.stringify(availableScales));
            });

            $(document).on('click', e => {
                if (!$(e.target).closest('.list-item').length) {
                    $('.list-item').removeClass('selected');
                    selectedScale = null;
                }
            });
        });

        function loadScales(scales) {
            availableScales = scales;
            renderList();
        }
    </script>
</body>

</html>