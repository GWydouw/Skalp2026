<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="css/material_dialog.css" rel="stylesheet">
    <script src='js/vue.min.js'></script>

</head>

<body onload="ready_materialSelector()" onmouseleave="su_focus()" onresize="position()" scroll="no"
    style="OVERFLOW: hidden">
    <div id="app">
        <div>
            <img class="in-model" src="icons/14x13_in_model.png" onclick="in_model_materials()">
            <select v-model="selected_library" class="form-control material-select" onchange="library(this.value)"
                onfocus="this.selectedIndex = 1">
                <option v-for="library in libraries" v-bind:value="library">
                    {{library}}
                </option>
            </select>
        </div>
        <div class="mygrid-wrapper-div">
            <div v-if="skalp_materials === true" class="material-div" v-for="material in materials"
                @mouseenter="hide_context_menu">
                <img v-on:mouseover="hover_material(material.name)"
                    v-on:contextmenu.prevent="show_context_menu($event, material.name)" class='image-border' width='54'
                    height='18' v-bind:src="material.source" v-bind:style="{top: material.preview_top + 'px'}" alt=''
                    data-toggle='tooltip' data-placement='top' v-bind:title="material.name"
                    v-on:click="selectmaterial(material.name)">
                <span v-on:mouseover="hover_material(material.name)"
                    v-on:contextmenu.prevent="show_context_menu($event, material.name)" class="material-text"
                    v-bind:style="{top: material.text_top + 'px'}" v-bind:title="material.name"
                    v-on:click="selectmaterial(material.name)">{{material.name}}</span>
            </div>
            <div class="material-div" v-else @mouseenter="hide_context_menu">
                <img v-on:mouseover="hover_material(material.name)" class='clip-image' width='54' height='54'
                    v-bind:src="material.source" v-bind:style="{top: material.preview_top + 'px'}" alt=''
                    data-toggle='tooltip' data-placement='top' v-bind:title="material.name"
                    v-on:contextmenu.prevent="show_context_menu($event, material.name)">
                <span v-on:mouseover="hover_material(material.name)" class="material-text"
                    v-bind:style="{top: material.text_top + 'px'}" v-bind:title="material.name"
                    v-on:click="selectmaterial(material.name)" v-on:mouseover="isHovering = true"
                    v-on:mouseleave="isHovering = false"
                    v-on:contextmenu.prevent="show_context_menu($event, material.name)">{{material.name}}</span>
            </div>
        </div>
        <div id="library_actions">
            <select class="material-menu" onchange="material_menu(this, this.value)">
                <option value="material">Material</option>
                <option value="save_all">Save All to New Library</option>
                <option value="export">Export Patterns to LayOut</option>
            </select>
            <select class="library-menu" onchange="library_menu(this, this.value)">
                <option value="library">Library</option>
                <option value="new">New</option>
            </select>
        </div>

    </div>

    <script src="js/material_dialog.js"></script>
    <script>
        let current_context_material = null;
        let context_menu_active = false;

        function show_context_menu(event, material) {
            context_menu_active = true;
            const isExternalLibrary = !(app.selected_library === "Skalp materials in model" || app.selected_library === "SketchUp materials in model");

            // Toon of verberg 'data-only-library' menu items
            document.querySelectorAll("#context-menu [data-only-library]").forEach(el => {
                el.style.display = isExternalLibrary ? 'block' : 'none';
            });

            // Toon of verberg 'data-only-model' menu items
            document.querySelectorAll("#context-menu [data-only-model]").forEach(el => {
                el.style.display = !isExternalLibrary ? 'block' : 'none';
            });

            app.selectmaterial(material); // selecteert ook het materiaal visueel
            event.preventDefault();
            current_context_material = material;
            const menu = document.getElementById("context-menu");
            menu.style.display = "block";
            menu.style.left = event.pageX + "px";
            menu.style.top = event.pageY + "px";
            // Remove any old context-active classes
            document.querySelectorAll('.context-active').forEach(el => el.classList.remove('context-active'));
            event.currentTarget.classList.add('context-active');
        }

        function hide_context_menu() {
            context_menu_active = false;
            document.getElementById("context-menu").style.display = "none";
            // Remove any context-active classes
            document.querySelectorAll('.context-active').forEach(el => el.classList.remove('context-active'));
        }

        document.addEventListener("click", function (event) {
            hide_context_menu();
        });

        document.addEventListener("keydown", function (event) {
            if (event.key === "Escape") {
                hide_context_menu();
            }
        });

        // Globale mousemove-listener voor context-menu hiding
        document.addEventListener('mousemove', function (event) {
            const menu = document.getElementById("context-menu");
            const overMenu = menu.contains(event.target);
            const overActive = event.target.closest('.material-div')?.classList.contains('context-active');
            if (menu.style.display === "block" && !overMenu && !overActive) {
                hide_context_menu();
            }
        });

        function context_edit_material() {
            app.selectmaterial(current_context_material);
            sketchup.material_menu('edit', current_context_material);
        }

        function context_copy_material() {
            app.selectmaterial(current_context_material);
            sketchup.material_menu('copy', current_context_material);
        }

        function context_move_material() {
            app.selectmaterial(current_context_material);
            sketchup.material_menu('move', current_context_material);
        }

        function context_remove_material() {
            app.selectmaterial(current_context_material);
            sketchup.material_menu('remove', current_context_material);
        }
        function context_rename_material() {
            app.selectmaterial(current_context_material);
            sketchup.material_menu('rename', current_context_material);
        }

        function context_merge_material() {
            app.selectmaterial(current_context_material);
            sketchup.material_menu('merge', current_context_material);
        }

    </script>

    <div id="context-menu"
        style="display:none; position:absolute; background:#fff; border:1px solid #ccc; z-index:1000;"
        @mouseleave="hide_context_menu" onmouseenter="event.stopPropagation()">
        <ul style="list-style:none; margin:0; padding:5px;">
            <li onclick="context_edit_material()">Edit</li>
            <li onclick="context_rename_material()" data-only-library>Rename</li>
            <li onclick="context_remove_material()">Remove</li>
            <li onclick="context_copy_material()">Copy to Library</li>
            <li onclick="context_move_material()" data-only-library>Move to Library</li>
            <li onclick="context_merge_material()" data-only-model>Merge with...</li>
        </ul>
    </div>

</body>

</html>